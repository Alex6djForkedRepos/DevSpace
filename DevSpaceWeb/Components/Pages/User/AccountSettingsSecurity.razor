@using DevSpaceWeb.Fido2
@using DevSpaceWeb.Models.Accounts
@using Microsoft.Extensions.Caching.Distributed
@using System.Globalization
@inject IJSRuntime JS
@inject DialogService DialogService
@inject HttpContextAccessor Http
@inject UserManager<AuthUser> UserManager
@inject NavigationManager Nav
@implements IDisposable
@inject IMemoryCache Cache

<PageTitle>Account Security | @_Data.Config.Instance.Name</PageTitle>
@if (AuthUser != null)
{
    <RadzenRow Gap="10px" RowGap="10px">
        <RadzenColumn SizeMD="6" SizeSM="12" class="settings-box">
            <h6>Security</h6>
            <RadzenRow Gap="10px" RowGap="10px" class="mt-4">
                <RadzenColumn SizeSM="12">
                    <RadzenStack Orientation="Orientation.Horizontal">
                        <span class="iconify settings-icon" style="color: var(--rz-success);" data-icon="mdi:check-circle"></span>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mb-05">
                                Account Secure
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">
                                Recommended to setup 2FA.
                            </RadzenText>
                        </div>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">

                        @if (AuthUser == null)
                        {
                            <div>
                                <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:password"></span>
                            </div>
                            <div>
                                <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                    Password Strength
                                </RadzenText>
                                <RadzenSkeleton></RadzenSkeleton>
                            </div>
                        }
                        else
                        {
                            if (AuthUser.Account.PasswordStrength == UserPasswordStrength.Low)
                            {
                                <div>
                                    <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:password-alert"></span>
                                </div>
                                <div>
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                        Password Strength
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">@AuthUser?.Account.PasswordStrength.ToString()</RadzenText>
                                </div>
                            }
                            else
                            {
                                <div>
                                    <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:password"></span>
                                </div>
                                <div>
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                        Password Strength
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">@AuthUser?.Account.PasswordStrength.ToString()</RadzenText>
                                </div>
                            }
                        }

                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:password-reset"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                Password Changed
                            </RadzenText>
                            @if (AuthUser == null)
                            {
                                <RadzenSkeleton></RadzenSkeleton>
                            }
                            else
                            {
                                if (AuthUser.Account.PasswordChangedAt.HasValue)
                                {
                                    <RadzenText TextStyle="TextStyle.Body2">@Utils.GetLocalDate(Session, AuthUser.Account.PasswordChangedAt.Value, true)</RadzenText>
                                }
                                else
                                {
                                    <RadzenText TextStyle="TextStyle.Body2">No</RadzenText>
                                }
                            }
                        </div>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:clock-time-three"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                Last Login
                            </RadzenText>
                            @if (AuthUser == null)
                            {
                                <RadzenSkeleton></RadzenSkeleton>
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Body2">@Utils.GetLocalDate(Session, AuthUser.Account.LoginAt, true)</RadzenText>
                            }
                        </div>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:email"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                Email Changed
                            </RadzenText>
                            @if (AuthUser == null)
                            {
                                <RadzenSkeleton></RadzenSkeleton>
                            }
                            else
                            {
                                if (AuthUser.Account.EmailChangedAt.HasValue)
                                {
                                    <RadzenText TextStyle="TextStyle.Body2">@Utils.GetLocalDate(Session, AuthUser.Account.EmailChangedAt.Value, true)</RadzenText>
                                }
                                else
                                {
                                    <RadzenText TextStyle="TextStyle.Body2">No</RadzenText>
                                }
                            }
                        </div>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:wide-area-network"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                Current IP
                            </RadzenText>
                            <RadzenTextMask Value="@CurrentIp" IsIp="true"></RadzenTextMask>
                        </div>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:world"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                Current Region
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">@CurrentCountry</RadzenText>
                        </div>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
            @* @if (AuthUser != null)
            {
                <div class="session-item">
                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                        Email Code
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">
                        Sent: @(Utils.GetLocalDate(Session, AuthUser.Mfa.EmailCodeLastSentAt, false))
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">
                        Used: @(Utils.GetLocalDate(Session, AuthUser.Mfa.EmailCodeLastUsedAt, false))
                    </RadzenText>
                </div>
            } *@
        </RadzenColumn>
        <RadzenColumn SizeMD="6" SizeSM="12" class="settings-box">
            <h6>2FA Status</h6>
            <RadzenRow Gap="10px" RowGap="10px" class="mt-4">
                <RadzenColumn SizeSM="12">
                    <RadzenStack Orientation="Orientation.Horizontal">

                        @if (AuthUser == null || !AuthUser.EmailConfirmed)
                        {
                            <span class="iconify settings-icon" style="color: var(--rz-danger);" data-icon="mdi:cross-circle"></span>
                            <div>
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mb-05">
                                    Account not Verified
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">
                                    You need to confirm your email address to setup 2FA.
                                </RadzenText>
                            </div>

                        }
                        else if (!AuthUser.Mfa.IsTwoFactorEnabled)
                        {
                            <span class="iconify settings-icon" style="color: var(--rz-warning);" data-icon="mdi:minus-circle"></span>
                            <div>
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mb-05">
                                    Email-Only
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">
                                    Verification using email codes.
                                </RadzenText>
                            </div>

                        }
                        else
                        {
                            <span class="iconify settings-icon" style="color: var(--rz-success);" data-icon="mdi:check-circle"></span>
                            <div>
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mb-05">
                                    Enabled
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2">
                                    Email codes have been disabled.
                                </RadzenText>

                            </div>
                            <RadzenButton Text="Disable 2FA" Style="max-height: 36px; margin-left: 10px;" ButtonStyle="ButtonStyle.Danger" Shade="Shade.Dark" Click="@Disable2FA" />

                        }
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:email"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-1">
                                Email Code
                            </RadzenText>
                            @if (AuthUser == null)
                            {
                                <RadzenSkeleton></RadzenSkeleton>
                            }
                            else if (!AuthUser.EmailConfirmed)
                            {
                                <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Danger" Text="Disabled" />
                            }
                            else if (!AuthUser.Mfa.IsTwoFactorEnabled)
                            {
                                <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Success" Text="Enabled" />
                            }
                            else
                            {
                                <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Light" Text="Disabled" />
                            }

                        </div>

                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:file-key"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-1">
                                Backup Code
                            </RadzenText>
                            @if (AuthUser == null)
                            {
                                <RadzenSkeleton></RadzenSkeleton>
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(AuthUser.Mfa.RecoveryCode))
                                {
                                    <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Success" Text="Enabled" />
                                }
                                else
                                {
                                    <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Danger" Text="Disabled" />
                                }
                            }
                        </div>

                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:cellphone-key"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-1">
                                Authenticator App
                            </RadzenText>
                            @if (AuthUser == null)
                            {
                                <RadzenSkeleton></RadzenSkeleton>
                            }
                            else
                            {
                                if (AuthUser.Mfa.AuthenticatorDevices.Any())
                                {
                                    <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Success" Text="Enabled" />
                                }
                                else
                                {
                                    <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Danger" Text="Disabled" />
                                }
                            }
                        </div>

                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="12" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:key-chain"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-1">
                                Passkeys (WebAuth)
                            </RadzenText>
                            @if (AuthUser == null)
                            {
                                <RadzenSkeleton></RadzenSkeleton>
                            }
                            else
                            {
                                if (AuthUser.Mfa.Passkeys.Any())
                                {
                                    <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Success" Text="Enabled" />
                                }
                                else
                                {
                                    <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Danger" Text="Disabled" />
                                }
                            }
                        </div>

                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn SizeMD="6" SizeSM="6" class="session-item">
                    <RadzenStack Gap="12px" Orientation="Orientation.Horizontal" Style="opacity: 0.6;">
                        <div>
                            <span class="iconify settings-icon" style="color: #EAEBEC;" data-icon="mdi:shield-key"></span>
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                Dev Space App
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">
                                Coming Soon
                            </RadzenText>
                        </div>

                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenColumn>
     </RadzenRow>

    <RadzenRow Gap="10px" RowGap="10px">
        <RadzenColumn SizeMD="6" SizeSM="12" class="settings-box">
            <h6>Sessions</h6>
            @if (AuthUser == null)
            {
                <br />
                <RadzenSkeleton></RadzenSkeleton>
                <RadzenSkeleton></RadzenSkeleton>
                <RadzenSkeleton></RadzenSkeleton>
            }
            else
            {
                <RadzenStack Orientation="Orientation.Vertical" Gap="10px">
                    @foreach (KeyValuePair<string, UserSession> i in AuthUser.Account.Sessions.OrderByDescending(x => x.Value.CreatedAt))
                    {
                        <div class="session-item">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceAround">
                                <div>
                                    @switch (i.Value.BrowserType)
                                    {
                                        case SessionBrowserType.Firefox:
                                            <span class="iconify" data-icon="logos:firefox"></span>
                                            break;
                                        case SessionBrowserType.Chrome:
                                            <span class="iconify" data-icon="logos:chrome"></span>
                                            break;
                                        case SessionBrowserType.Edge:
                                            <span class="iconify" data-icon="logos:microsoft-edge"></span>
                                            break;
                                        case SessionBrowserType.InternetExplorer:
                                            <span class="iconify" data-icon="logos:internetexplorer"></span>
                                            break;
                                        case SessionBrowserType.Opera:
                                            <span class="iconify" data-icon="logos:opera"></span>
                                            break;
                                        case SessionBrowserType.Safari:
                                            <span class="iconify" data-icon="logos:safari"></span>
                                            break;
                                        case SessionBrowserType.Vivaldi:
                                            <span class="iconify" data-icon="logos:vivaldi-icon"></span>
                                            break;
                                        case SessionBrowserType.Unknown:
                                            <span class="iconify" data-icon="mdi:web"></span>
                                            break;
                                    }
                                    @if (i.Value.IsMobile)
                                    {
                                        <span class="iconify" data-icon="mdi:mobile-phone"></span>
                                    }
                                    else
                                    {
                                        <span class="iconify" data-icon="mdi:computer-classic"></span>
                                    }
                                </div>

                                <RadzenStack Gap="0px" Style="flex-grow: 2;">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-1">
                                        @if (i.Key == Session.CurrentSessionId)
                                        {
                                            <span>@(i.Value.Name) <RadzenBadge BadgeStyle="BadgeStyle.Info" Shade="Shade.Darker" Text="Current Session" class="ml-1" /></span>
                                        }
                                        else
                                        {
                                            @i.Value.Name
                                        }
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        <span>Created: @(Utils.GetLocalDate(Session, i.Value.CreatedAt, true))</span>
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        <span>Last Login: @(Utils.GetLocalDate(Session, i.Value.LastLoginAt, true))</span>
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        <span>Region: @i.Value.Country</span>
                                    </RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="10px" AlignItems="AlignItems.Stretch" JustifyContent="JustifyContent.Center">
                                    <RadzenButton Text="Edit" ButtonStyle="ButtonStyle.Primary" Shade="Shade.Dark" Size="ButtonSize.Small" Click="@(() => EditSession(i.Key))" />
                                    <RadzenButton Text="Remove" ButtonStyle="ButtonStyle.Warning" Shade="Shade.Darker" Size="ButtonSize.Small" Click="@(() => RemoveSession(i.Key))" />
                                </RadzenStack>

                            </RadzenStack>





                        </div>
                    }
                </RadzenStack>
                <br />
                <RadzenButton Text="Remove All Sessions" ButtonStyle="ButtonStyle.Danger" Shade="Shade.Dark" Click="@RemoveAllSessions" />
            }
        </RadzenColumn>
        <RadzenColumn SizeMD="6" SizeSM="12" class="settings-box">
            <h6>2FA Methods</h6>
            @if (AuthUser == null)
            {
                <br />
                <RadzenSkeleton></RadzenSkeleton>
                <RadzenSkeleton></RadzenSkeleton>
                <RadzenSkeleton></RadzenSkeleton>
            }
            else
            {

            <div class="session-item">
                <RadzenText TextStyle="TextStyle.Subtitle1">
                    Backup Code
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">
                    Use this code to get back into your account if you lose access.
                </RadzenText>

                @if (AuthUser.Mfa.IsTwoFactorEnabled)
                {
                    @if (string.IsNullOrEmpty(AuthUser.Mfa.RecoveryCode))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Dark" AllowClose="false">
                            You have not created a backup code!
                        </RadzenAlert>
                        <br />
                        <RadzenButton Text="Generate" ButtonStyle="ButtonStyle.Info" Shade="Shade.Dark" Click="@GenerateBackupCodes" />
                    }
                    else
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Dark" AllowClose="false">
                            Backup codes have been generated.
                        </RadzenAlert>
                        <p>Generated: @(Utils.GetLocalDate(Session, AuthUser.Mfa.RecoveryCodeCreatedAt, true))</p>
                        <p>Last Used: @(Utils.GetLocalDate(Session, AuthUser.Mfa.RecoveryCodeLastUsedAt, true))</p>
                        <br />
                        <RadzenButton Text="Reset" ButtonStyle="ButtonStyle.Warning" Shade="Shade.Dark" Click="@GenerateBackupCodes" />
                    }
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Dark" AllowClose="false">
                        Setup Authenticator or Passkeys to generate a backup code.
                    </RadzenAlert>

                }
            </div>
            <br />
            <div class="session-item">
                <RadzenText TextStyle="TextStyle.Subtitle1">
                    Authenticator App
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">
                    Last Registered: @(Utils.GetLocalDate(Session, AuthUser.Mfa.AuthenticatorLastRegisteredAt, true))
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">
                    Last Used: @(Utils.GetLocalDate(Session, AuthUser.Mfa.AuthenticatorLastUsedAt, true))
                </RadzenText>
                <br />
                <h5 class="mb-2">Devices</h5>


                <RadzenStack Orientation="Orientation.Vertical" Gap="10px">
                    @foreach (KeyValuePair<string, bool> i in AuthUser.Mfa.AuthenticatorDevices)
                    {
                        <div class="passkey-item">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceAround">
                                <RadzenStack Gap="0px" Style="flex-grow: 2;">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-1">
                                        @i.Key
                                    </RadzenText>
                                    <div>
                                        @if (i.Value)
                                        {
                                            <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Success" Text="Registered" />
                                        }
                                        else
                                        {
                                            <RadzenBadge Shade="Shade.Darker" BadgeStyle="BadgeStyle.Warning" Text="Unregistered" />
                                        }
                                    </div>

                                </RadzenStack>
                                <RadzenStack Gap="10px" AlignItems="AlignItems.Stretch" JustifyContent="JustifyContent.Center">
                                    <RadzenButton Text="Edit" ButtonStyle="ButtonStyle.Primary" Shade="Shade.Dark" Size="ButtonSize.Small" Click="@(() => EditAuthenticator(i.Key))" />
                                </RadzenStack>

                            </RadzenStack>
                        </div>
                    }
                </RadzenStack>
                <br />
                <br />
                <RadzenButton Text="Register" ButtonStyle="ButtonStyle.Success" Shade="Shade.Dark" Click="@RegisterAuthenticator" Disabled="@(!AuthUser.EmailConfirmed)" />
                @* <RadzenButton Text="Test" ButtonStyle="ButtonStyle.Info" Shade="Shade.Dark" Click="@TestPasskey" Disabled="@(!AuthUser.EmailConfirmed || !AuthUser.Mfa.AuthenticatorDevices.Any())" /> *@
                <RadzenButton Text="Remove All" ButtonStyle="ButtonStyle.Danger" Shade="Shade.Dark" Click="@RemoveAllAuthenticators" Disabled="@(!AuthUser.EmailConfirmed || !AuthUser.Mfa.AuthenticatorDevices.Any())" />
            </div>
            <br />
            <div class="session-item">
                <RadzenText TextStyle="TextStyle.Subtitle1">
                    Passkeys (WebAuthn)
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">
                    Last Registered: @(Utils.GetLocalDate(Session, AuthUser.Mfa.PasskeyLastRegisteredAt, false))
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">
                    Last Used: @(Utils.GetLocalDate(Session, AuthUser.Mfa.PasskeyLastUsedAt, true))
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">
                    Last Device: @AuthUser.Mfa.PasskeyLastUsedDevice
                </RadzenText>
                <br />
                <h5 class="mb-2">Devices</h5>
                <RadzenStack Orientation="Orientation.Vertical" Gap="10px">
                    @foreach (FidoStoredCredential i in AuthUser.Mfa.Passkeys)
                    {
                        <div class="passkey-item">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceAround">
                                <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyB0cmFuc2Zvcm09Im1hdHJpeCgxLCAwLCAwLCAxLCAyNy4wMDkwMDEsIC0zOS4yMzg5OTgpIj4KICAgIDxwYXRoIGZpbGw9IiM0Mjg1RjQiIGQ9Ik0gLTMuMjY0IDUxLjUwOSBDIC0zLjI2NCA1MC43MTkgLTMuMzM0IDQ5Ljk2OSAtMy40NTQgNDkuMjM5IEwgLTE0Ljc1NCA0OS4yMzkgTCAtMTQuNzU0IDUzLjc0OSBMIC04LjI4NCA1My43NDkgQyAtOC41NzQgNTUuMjI5IC05LjQyNCA1Ni40NzkgLTEwLjY4NCA1Ny4zMjkgTCAtMTAuNjg0IDYwLjMyOSBMIC02LjgyNCA2MC4zMjkgQyAtNC41NjQgNTguMjM5IC0zLjI2NCA1NS4xNTkgLTMuMjY0IDUxLjUwOSBaIi8+CiAgICA8cGF0aCBmaWxsPSIjMzRBODUzIiBkPSJNIC0xNC43NTQgNjMuMjM5IEMgLTExLjUxNCA2My4yMzkgLTguODA0IDYyLjE1OSAtNi44MjQgNjAuMzI5IEwgLTEwLjY4NCA1Ny4zMjkgQyAtMTEuNzY0IDU4LjA0OSAtMTMuMTM0IDU4LjQ4OSAtMTQuNzU0IDU4LjQ4OSBDIC0xNy44ODQgNTguNDg5IC0yMC41MzQgNTYuMzc5IC0yMS40ODQgNTMuNTI5IEwgLTI1LjQ2NCA1My41MjkgTCAtMjUuNDY0IDU2LjYxOSBDIC0yMy40OTQgNjAuNTM5IC0xOS40NDQgNjMuMjM5IC0xNC43NTQgNjMuMjM5IFoiLz4KICAgIDxwYXRoIGZpbGw9IiNGQkJDMDUiIGQ9Ik0gLTIxLjQ4NCA1My41MjkgQyAtMjEuNzM0IDUyLjgwOSAtMjEuODY0IDUyLjAzOSAtMjEuODY0IDUxLjIzOSBDIC0yMS44NjQgNTAuNDM5IC0yMS43MjQgNDkuNjY5IC0yMS40ODQgNDguOTQ5IEwgLTIxLjQ4NCA0NS44NTkgTCAtMjUuNDY0IDQ1Ljg1OSBDIC0yNi4yODQgNDcuNDc5IC0yNi43NTQgNDkuMjk5IC0yNi43NTQgNTEuMjM5IEMgLTI2Ljc1NCA1My4xNzkgLTI2LjI4NCA1NC45OTkgLTI1LjQ2NCA1Ni42MTkgTCAtMjEuNDg0IDUzLjUyOSBaIi8+CiAgICA8cGF0aCBmaWxsPSIjRUE0MzM1IiBkPSJNIC0xNC43NTQgNDMuOTg5IEMgLTEyLjk4NCA0My45ODkgLTExLjQwNCA0NC41OTkgLTEwLjE1NCA0NS43ODkgTCAtNi43MzQgNDIuMzY5IEMgLTguODA0IDQwLjQyOSAtMTEuNTE0IDM5LjIzOSAtMTQuNzU0IDM5LjIzOSBDIC0xOS40NDQgMzkuMjM5IC0yMy40OTQgNDEuOTM5IC0yNS40NjQgNDUuODU5IEwgLTIxLjQ4NCA0OC45NDkgQyAtMjAuNTM0IDQ2LjA5OSAtMTcuODg0IDQzLjk4OSAtMTQuNzU0IDQzLjk4OSBaIi8+CiAgPC9nPgo8L3N2Zz4=" />

                                <RadzenStack Gap="0px" Style="flex-grow: 2;">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-05">
                                        @i.Name
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        <span>Created: @(Utils.GetLocalDate(Session, i.CreatedAt, true))</span>
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        <span>Last Used: @(Utils.GetLocalDate(Session, i.LastUsedAt, true))</span>
                                    </RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="10px" AlignItems="AlignItems.Stretch" JustifyContent="JustifyContent.Center">
                                    <RadzenButton Text="Edit" ButtonStyle="ButtonStyle.Primary" Shade="Shade.Dark" Size="ButtonSize.Small" Click="@(() => EditPasskey(i))" />
                                    <RadzenButton Text="Remove" ButtonStyle="ButtonStyle.Warning" Shade="Shade.Darker" Size="ButtonSize.Small" Click="@(() => RemovePasskey(i))" />
                                </RadzenStack>

                            </RadzenStack>
                        </div>
                    }

                </RadzenStack>
                <br />
                <br />
                <RadzenButton Text="Register" ButtonStyle="ButtonStyle.Success" Shade="Shade.Dark" Click="@RegisterPasskey" Disabled="@(!AuthUser.EmailConfirmed)" />
                <RadzenButton Text="Test" ButtonStyle="ButtonStyle.Info" Shade="Shade.Dark" Click="@TestPasskey" Disabled="@(!AuthUser.EmailConfirmed || !AuthUser.Mfa.Passkeys.Any())" />
                <RadzenButton Text="Remove All" ButtonStyle="ButtonStyle.Danger" Shade="Shade.Dark" Click="@RemoveAllPasskeys" Disabled="@(!AuthUser.EmailConfirmed || !AuthUser.Mfa.Passkeys.Any())" />
            </div>
            }
        </RadzenColumn>
    </RadzenRow>
    }


<style>
    .settings-icon {
    width: 40px;
    height: 40px;
    }
</style>

@code {
    [CascadingParameter]
    private SessionProvider Session { get; set; }

    public AuthUser? AuthUser { get; set; }

    public string CurrentCountry { get; set; }
    public string CurrentIp { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _DB.SessionUpdated += SessionChangedEvent;
        AuthUser = await Session.GetCurrentUserAsync();
        CurrentCountry = await Session.GetCountryAsync();
        CurrentIp = Utils.GetUserIpAddress(Http.HttpContext);
        //var Meta = await Fido2Service._metadata.GetEntryAsync(AuthUser.PasskeyTokens.First().AaGuid);
        //Console.WriteLine("Meta: " + Meta.MetadataStatement.Description);
    }

    public void Dispose()
    {
        _DB.SessionUpdated -= SessionChangedEvent;
    }

    public async void SessionChangedEvent(ObjectId user, SessionEventType type)
    {
        if (AuthUser.Id != user || type != SessionEventType.AccountUpdate)
            return;

        AuthUser = await Session.GetCurrentUserAsync();
        _ = InvokeAsync(StateHasChanged);

    }

    public async Task EditSession(string id)
    {
        AuthUser = await Session.GetCurrentUserAsync();
        if (AuthUser != null && AuthUser.Account.Sessions.TryGetValue(id, out UserSession? session))
        {
            if (AuthUser.Mfa.IsTwoFactorEnabled)
            {
                bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
                if (!TwoFactorValid)
                {
                    await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                    return;
                }
            }

            await DialogService.ShowDynamicFormAsync<AccountItemEditModel>("Edit Session", new AccountItemEditModel { Name = session.Name }, async (AccountItemEditModel data) =>
            {
                AuthUser = await Session.GetCurrentUserAsync();
                if (AuthUser != null && AuthUser.Account.Sessions.TryGetValue(id, out UserSession? session))
                {
                    session.Name = data.Name;
                    await UserManager.UpdateAsync(AuthUser);
                    StateHasChanged();
                }

                return null;
            });
        }      
    }

    public async Task RemoveSession(string id)
    {
        AuthUser = await Session.GetCurrentUserAsync();
        if (AuthUser.Mfa.IsTwoFactorEnabled)
        {
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {
                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }
        }

        AuthUser = await Session.GetCurrentUserAsync();
        AuthUser.Account.Sessions.Remove(id);
        await UserManager.UpdateAsync(AuthUser);
        _DB.TriggerSessionEvent(AuthUser.Id, SessionEventType.AccountUpdate);
        if (id == Session.CurrentSessionId)
        {
            Session.SessionError = SessionProvider.SessionErrorType.Loading;
            Nav.NavigateTo("/logout", true);
        }
        else
        {
            StateHasChanged();
        }
    }

    public async Task RemoveAllSessions()
    {
        bool Confirm = await DialogService.ShowConfirmAsync("Remove All Sessions", "This will remove all login sessions except the current one.", "Confirm", ButtonStyle.Warning);
        if (Confirm)
        {
            AuthUser = await Session.GetCurrentUserAsync();
            if (AuthUser.Mfa.IsTwoFactorEnabled)
            {
                bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
                if (!TwoFactorValid)
                {
                    await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                    return;
                }
            }

            AuthUser = await Session.GetCurrentUserAsync();
            AuthUser.Account.Sessions = AuthUser.Account.Sessions.Where(x => x.Key == Session.CurrentSessionId).ToDictionary();
            await UserManager.UpdateAsync(AuthUser);
            _DB.TriggerSessionEvent(AuthUser.Id, SessionEventType.AccountUpdate);
            StateHasChanged();
        }
    }

    public async Task RegisterPasskey()
    {

        bool DetectPasskeyAllow = false;
        try
        {
            DetectPasskeyAllow = await JS.InvokeAsync<bool>("window.Passkey.isPasskeySupported");
        }
        catch { }
        if (!DetectPasskeyAllow)
        {
            await DialogService.ShowInfoAsync("Passkey Info", "This device does not support passkeys.");
            return;
        }

        AuthUser = await Session.GetCurrentUserAsync();
        if (AuthUser == null)
            return;

        if (!AuthUser.EmailConfirmed)
        {
            await DialogService.ShowInfoAsync("Account Info", "You can't setup 2FA because your email is not verified.");
            return;
        }


        if (AuthUser.Mfa.IsTwoFactorEnabled)
        {
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {

                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }
        }

        DialogOptions options = new DialogOptions() { };

        await DialogService.OpenAsync<RegisterPasskeyDialog>("Register Passkey", new Dictionary<string, object>(), options);

    }

    public async Task TestPasskey()
    {
        bool DetectPasskeyAllow = false;
        try
        {
            DetectPasskeyAllow = await JS.InvokeAsync<bool>("window.Passkey.isPasskeySupported");
        }
        catch { }
        if (!DetectPasskeyAllow)
        {
            await DialogService.ShowInfoAsync("Passkey Info", "This device does not support passkeys.");
            return;
        }

        bool Result = await Session.TestPasskey(false);
        if (Result)
            await DialogService.ShowInfoAsync("Passkey Test", "Your passkey was successful");
        else
            await DialogService.ShowInfoAsync("Passkey Test", "Your passkey failed to validate");
    }

    public async Task EditPasskey(FidoStoredCredential cred)
    {
        AuthUser = await Session.GetCurrentUserAsync();
        if (AuthUser != null)
        {
            if (AuthUser.Mfa.IsTwoFactorEnabled)
            {
                bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
                if (!TwoFactorValid)
                {
                    await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                    return;
                }
            }
            await DialogService.ShowDynamicFormAsync<AccountItemEditModel>("Edit Passkey", new AccountItemEditModel { Name = cred.Name }, async (AccountItemEditModel data) =>
            {
                AuthUser = await Session.GetCurrentUserAsync();
                if (AuthUser != null)
                {
                    string Key = System.Text.Encoding.UTF8.GetString(cred.Descriptor.Id);
                    FidoStoredCredential? Cred = AuthUser.Mfa.Passkeys.FirstOrDefault(x => System.Text.Encoding.UTF8.GetString(x.Descriptor.Id) == Key);
                    if (Cred != null)
                    {
                        Cred.Name = data.Name;
                        await UserManager.UpdateAsync(AuthUser);
                        StateHasChanged();
                    }
                }

                return null;
            });
        }
    }

    public async Task RemovePasskey(FidoStoredCredential cred)
    {
        AuthUser = await Session.GetCurrentUserAsync();
        if (AuthUser.Mfa.IsTwoFactorEnabled)
        {
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {
                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }
        }
        AuthUser = await Session.GetCurrentUserAsync();
        if (AuthUser == null)
            return;
        AuthUser.Mfa.Passkeys = AuthUser.Mfa.Passkeys.Where(x => System.Text.Encoding.UTF8.GetString(x.Descriptor.Id) != System.Text.Encoding.UTF8.GetString(cred.Descriptor.Id)).ToList();
        if (!AuthUser.Mfa.HasAny2FA())
            AuthUser.Mfa.Disable2FA(AuthUser);

        await UserManager.UpdateAsync(AuthUser);
        _DB.TriggerSessionEvent(AuthUser.Id, SessionEventType.AccountUpdate);
        StateHasChanged();

    }

    public async Task RegisterAuthenticator()
    {
        AuthUser = await Session.GetCurrentUserAsync();

        if (!AuthUser.EmailConfirmed)
        {
            await DialogService.ShowInfoAsync("Account Info", "You can't setup 2FA because your email is not verified.");
            return;
        }
        if (AuthUser.Mfa.IsTwoFactorEnabled)
        {
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {
                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }
        }
        AuthUser = await Session.GetCurrentUserAsync();

        string Key = await UserManager.GetAuthenticatorKeyAsync(AuthUser);
        if (string.IsNullOrEmpty(Key))
        {
            IdentityResult Result = await UserManager.ResetAuthenticatorKeyAsync(AuthUser);
            Key = await UserManager.GetAuthenticatorKeyAsync(AuthUser);
        }

        DialogOptions options = new DialogOptions() { };

        dynamic Dialog = await DialogService.OpenAsync<RegisterAuthenticatorDialog>("Register Authenticator", new Dictionary<string, object>()
        {
            { "SetupKey", Key },
            { "SetupUrl", $"otpauth://totp/{Uri.EscapeDataString(_Data.Config.Instance.Name)}:{Uri.EscapeDataString(AuthUser.Email)}?secret={Key}" },
        }, options);

        if (Dialog != null && Dialog == true)
        {
            await DialogService.ShowInfoAsync("Authenticator Verified", "The authenticator app has now been verified.");
            StateHasChanged();
        }
    }

    public async Task EditAuthenticator(string name)
    {
        AuthUser = await Session.GetCurrentUserAsync();
        if (AuthUser.Mfa.IsTwoFactorEnabled)
        {
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {
                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }
        }
        if (AuthUser != null)
        {
            await DialogService.ShowDynamicFormAsync<AccountItemEditModel>("Edit Authenticator", new AccountItemEditModel { Name = name }, async (AccountItemEditModel data) =>
            {
                AuthUser = await Session.GetCurrentUserAsync();
                if (AuthUser != null)
                {
                    if (AuthUser.Mfa.AuthenticatorDevices.ContainsKey(name))
                    {
                        AuthUser.Mfa.AuthenticatorDevices.Add(data.Name, AuthUser.Mfa.AuthenticatorDevices[name]);
                        AuthUser.Mfa.AuthenticatorDevices.Remove(name);
                        await UserManager.UpdateAsync(AuthUser);
                        StateHasChanged();
                    }
                }

                return null;
            });
        }
    }

    public async Task RemoveAllPasskeys()
    {
        AuthUser = await Session.GetCurrentUserAsync();
        if (!AuthUser.Mfa.Passkeys.Any())
        {
            await DialogService.ShowInfoAsync("Passkey Info", "You do not have any passkeys registered");
            return;
        }
        bool Confirm = await DialogService.ShowConfirmAsync("Remove All Passkeys", "Are you sure you want to remove all passkeys?", "Confirm", ButtonStyle.Warning);
        if (Confirm)
        {
            AuthUser = await Session.GetCurrentUserAsync();
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {
                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }

            AuthUser = await Session.GetCurrentUserAsync();

            AuthUser.Mfa.Passkeys.Clear();
            if (!AuthUser.Mfa.HasAny2FA())
                AuthUser.Mfa.Disable2FA(AuthUser);

            await UserManager.UpdateAsync(AuthUser);
            _DB.TriggerSessionEvent(AuthUser.Id, SessionEventType.AccountUpdate);
            StateHasChanged();
        }
    }

    public async Task RemoveAllAuthenticators()
    {
        AuthUser = await Session.GetCurrentUserAsync();
        if (!AuthUser.Mfa.AuthenticatorDevices.Any())
        {
            await DialogService.ShowInfoAsync("Authenticator Info", "You do not have any authenticators registered");
            return;
        }
        bool Confirm = await DialogService.ShowConfirmAsync("Remove All Authenticators", "Are you sure you want to remove all authenticators?", "Confirm", ButtonStyle.Warning);
        if (Confirm)
        {
            AuthUser = await Session.GetCurrentUserAsync();
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {
                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }

            AuthUser = await Session.GetCurrentUserAsync();
            IdentityUserToken<ObjectId>? Token = AuthUser.GetToken("[AspNetUserStore]", "AuthenticatorKey");
            if (Token != null)
                AuthUser.RemoveUserToken(Token);
            AuthUser.Mfa.AuthenticatorDevices.Clear();
            if (!AuthUser.Mfa.HasAny2FA())
                AuthUser.Mfa.Disable2FA(AuthUser);

            await UserManager.UpdateAsync(AuthUser);
            _DB.TriggerSessionEvent(AuthUser.Id, SessionEventType.AccountUpdate);
            StateHasChanged();
        }
    }

    public async Task GenerateBackupCodes()
    {
        AuthUser = await Session.GetCurrentUserAsync();
        if (!AuthUser.EmailConfirmed)
        {
            await DialogService.ShowInfoAsync("Account Info", "You can't setup 2FA because your email is not verified.");
            return;
        }

        if (AuthUser.Mfa.IsTwoFactorEnabled)
        {
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {
                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }
        }

        AuthUser = await Session.GetCurrentUserAsync();

        string Code = Utils.CreateTwoFactorRecoveryCode();

        string Key = Utils.CreateTwoFactorRecoveryCode();

        Cache.Set(Key, Code, new TimeSpan(0, 2, 0));

        AuthUser.Mfa.RecoveryCode = Utils.Hasher.HashPassword(AuthUser, Code);
        AuthUser.Mfa.RecoveryCodeCreatedAt = DateTime.UtcNow;
        await UserManager.UpdateAsync(AuthUser);

        DialogOptions options = new DialogOptions() { };

        dynamic Dialog = await DialogService.OpenAsync<ShowRecoveryCodesDialog>("Recovery Codes", new Dictionary<string, object>()
        {
            { "Code", Code },
            { "DownloadToken", Key }
        }, options);


        if (Dialog != null && Dialog == true)
        {
            _DB.TriggerSessionEvent(AuthUser.Id, SessionEventType.AccountUpdate);
            StateHasChanged();
        }

    }

    public async Task Disable2FA()
    {
        bool Confirm = await DialogService.ShowConfirmAsync("Disable 2FA", "This will remove all authenticator apps and passkeys?", "Confirm", ButtonStyle.Warning);
        if (Confirm)
        {
            AuthUser = await Session.GetCurrentUserAsync();
            bool TwoFactorValid = await Session.TriggerTwoFactorAuthentication(AuthUser, true, false);
            if (!TwoFactorValid)
            {
                await DialogService.ShowInfoAsync("2FA Failed", "Your Two-factor authentication method failed to verify.");
                return;
            }

            AuthUser = await Session.GetCurrentUserAsync();

            AuthUser.Mfa.Disable2FA(AuthUser);

            await UserManager.UpdateAsync(AuthUser);
            _DB.TriggerSessionEvent(AuthUser.Id, SessionEventType.AccountUpdate);
            StateHasChanged();
            await DialogService.ShowInfoAsync("2FA Disabled", "2FA has been disabled for your account including backup code.");
               
        }
    }
}
